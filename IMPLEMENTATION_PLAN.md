# План реализации веб-портала для видеозвонков

## Цель проекта
Создание простого веб-портала для групповых видеозвонков с автоматическим присоединением всех пользователей к общей конференции.

## Основные компоненты

### 1. Технологический стек
- **Frontend**: Next.js 16 + React 19 + TypeScript
- **WebRTC**: Нативный WebRTC API (RTCPeerConnection)
- **Signaling**: Socket.IO (для обмена сигналами между пользователями)
- **Server**: Custom Node.js server (Next.js + Socket.IO)
- **UI**: Tailwind CSS 4

### 2. Архитектура решения
```
┌─────────────┐         ┌─────────────────┐         ┌─────────────┐
│ Пользователь│◄───────►│  Socket.IO      │◄───────►│Пользователь │
│      A      │  Signal │   Server        │  Signal │      B      │
└─────────────┘         └─────────────────┘         └─────────────┘
       ▲                                                    ▲
       │                                                    │
       └────────────► WebRTC P2P (видео/аудио) ◄──────────┘

Mesh Topology: Каждый пользователь соединен напрямую со всеми остальными
```

**Ключевые особенности:**
- Автоматическое присоединение - не нужно вводить ID или коды
- Mesh topology - каждый участник соединен напрямую со всеми
- Socket.IO используется только для сигнализации (offer/answer/ICE)
- Медиа потоки передаются напрямую между браузерами (P2P)

### 3. Реализованные этапы

#### ✅ Этап 1: Установка зависимостей
```bash
npm install socket.io socket.io-client
npm install peerjs @types/peerjs  # Не используется, можно удалить
```

#### ✅ Этап 2: Создание custom сервера
- `server.js` - Node.js сервер, объединяющий Next.js и Socket.IO
- Обработка WebRTC сигналов (offer, answer, ICE candidates)
- Управление списком активных пользователей
- Автоматическое уведомление о присоединении/отключении участников

#### ✅ Этап 3: Компонент видеоконференции
- Автоматическая инициализация при загрузке страницы
- Получение доступа к камере и микрофону через `getUserMedia()`
- Подключение к Socket.IO серверу
- Создание WebRTC соединений со всеми существующими участниками
- Динамическое создание видео элементов для каждого участника

#### ✅ Этап 4: WebRTC Mesh соединения
- Создание RTCPeerConnection для каждого участника
- Обмен SDP offer/answer через Socket.IO
- Обмен ICE candidates для NAT traversal
- Автоматическое добавление треков (video/audio) в соединения
- Обработка входящих медиа потоков от других участников

#### ✅ Этап 5: Интерфейс пользователя
- Локальное видео (ваша камера)
- Сетка удаленных видео (другие участники)
- Счетчик участников
- Индикатор статуса соединения
- Кнопки управления: вкл/выкл микрофон, камера, завершить звонок
- Адаптивная сетка видео (responsive grid)

#### ✅ Этап 6: Обработка состояний
- Подключение к серверу
- Ожидание участников
- Активный звонок
- Присоединение/отключение участников
- Обработка ошибок (нет доступа к камере, потеря соединения)
- Корректное закрытие соединений при выходе

### 4. Структура файлов
```
/
├── server.js                    # Custom Node.js + Socket.IO сервер
├── app/
│   ├── layout.tsx              # Root layout
│   ├── page.tsx                # Главная страница
│   ├── globals.css             # Глобальные стили
│   ├── videocall/
│   │   └── page.tsx            # Страница видеоконференции
│   └── components/
│       ├── VideoCall.tsx       # WebRTC + Socket.IO логика
│       └── MediaControls.tsx   # Управление медиа
├── package.json                # npm scripts используют server.js
└── CLAUDE.md                   # Документация проекта
```

### 5. Развертывание

#### Локальная разработка
```bash
npm run dev  # Запускает server.js на порту 4057
```

Доступ:
- Локально: `http://localhost:4057`
- В локальной сети: `http://192.168.50.57:4057`
- Из интернета (через DMZ): `http://176.36.188.208:4057`

#### Доступ из локальной сети
Для доступа с других устройств в локальной сети:
1. Откройте `http://192.168.50.57:4057` на любом устройстве в сети
2. Все устройства автоматически присоединятся к общей конференции
3. Не нужно вводить коды или ID

#### Доступ из интернета
Настроен проброс порта 4057 через DMZ:
- Внешний IP: `176.36.188.208`
- Порт: `4057`
- Пользователи из интернета могут подключиться по адресу `http://176.36.188.208:4057`
- Все участники (локальные + удаленные) будут в одной конференции

#### Production
```bash
npm run build
npm run start
```

### 6. Минимальные требования
- Современный браузер с поддержкой WebRTC (Chrome, Firefox, Safari, Edge)
- Разрешение на использование камеры и микрофона
- Стабильное сетевое соединение
- Браузер должен поддерживать RTCPeerConnection API

### 7. Ограничения Mesh Topology
⚠️ **Важно:** Mesh topology подходит для небольшого количества участников (до 4-6 человек)
- Каждый участник создает N-1 соединений (где N - количество участников)
- При 4 участниках = 6 соединений (mesh)
- Требуется больше пропускной способности и CPU на каждого участника
- Для больших конференций рекомендуется SFU (Selective Forwarding Unit)

## Преимущества реализованного решения
✅ Автоматическое присоединение - просто откройте ссылку
✅ Не требует регистрации, ID или паролей
✅ Прямое P2P соединение (минимальная задержка)
✅ Бесплатное решение без внешних сервисов
✅ Работает в локальной сети без интернета
✅ Поддержка неограниченного количества участников (с ограничениями mesh)
✅ Простое развертывание - один сервер для всего
